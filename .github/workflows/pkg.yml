name: pkg
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Setup env
        uses: actions/checkout@v2
      - name: Download toolchain
        env:
          iccdl: ${{ secrets.ICCDLADDR }}
          icctar: ${{ secrets.ICCTARBALL }}
        run: |
          sudo apt-get -qq install zstd
          cd /home/runner/work/R-pkg/
          wget ${iccdl} -q
          tar -I zstd -xf ${icctar}
          rm ${icctar}
      - name: Install dependencies 1
        run: |
          sudo apt-get install subversion ccache texlive texlive-fonts-extra texlive-latex-extra libx11-dev libpcre2-dev libjpeg-dev libpng-dev libtiff-dev libxmu-dev libxt-dev libreadline-dev -y
          curl https://repogen.simplylinux.ch/txt/bionic/sources_dd16190d58c2ce272cf1b15983db2daaa096d075.txt | sudo tee /etc/apt/sources.list
          sudo apt-get -qq update
          sudo apt-get -qq build-dep r-base -y
          cd /home/runner/work/R-pkg/
          wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
          sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB
          sudo sh -c 'echo deb https://apt.repos.intel.com/mkl all main > /etc/apt/sources.list.d/intel-mkl.list'
      - name: Install intel mkl library
        run: |
          sudo apt-get -qq update
          sudo apt-get -qq install intel-mkl-2020.3-111 -y
      - name: Prepare R source tarball
        run: |
          export PATH=/home/runner/work/R-pkg/intel/bin/:$PATH
          export INTEL_LICENSE_FILE=/home/runner/work/R-pkg/intel
          source /opt/intel/mkl/bin/mklvars.sh intel64
          export _intel_arch=intel64
          export _intel_lib=mkl_intel_lp64
          export MKL="-L${MKLROOT}/lib/intel64 -lmkl_intel_lp64 -lmkl_intel_thread -lmkl_core -lmkl_rt -lpthread -lm -ldl"
          export _intel_cc_opt="-O3 -fPIC -m64 -march=native -fp-model precise -fp-model source -I${MKLROOT}/include"
          export LDFLAGS="-qopenmp"
          export CFLAGS="${_intel_cc_opt}"
          export CXXFLAGS="${_intel_cc_opt}"
          export FFLAGS="${_intel_cc_opt}"
          export FCFLAGS="${_intel_cc_opt}"
          export CC="icc"
          export CXX="icpc"
          export F77="ifort"
          export FC="ifort"
          export AR="xiar"
          export LD="xild"
          export LD_LIBRARY_PATH=/home/runner/work/R-pkg/intel/compilers_and_libraries_2020.3.275/linux/compiler/lib/intel64_lin/
          source /home/runner/work/R-pkg/intel/bin/compilervars.sh ${_intel_arch}
          cd /home/runner/work/R-pkg/
          wget "https://cran.r-project.org/src/base/R-4/R-4.0.2.tar.gz" -q
          tar zxf R-4.0.2.tar.gz && rm R-4.0.2.tar.gz
          cd R-4.0.2/
          sed -i '/^#undef HAVE_MATHERR/d' src/include/config.h.in
          ./configure --prefix=/usr --libdir=/usr/lib --sysconfdir=/etc/R --datarootdir=/usr/share rsharedir=/usr/share/R/ rincludedir=/usr/include/R/ rdocdir=/usr/share/doc/R/ --with-x --enable-R-shlib --with-blas="$MKL" --with-lapack --disable-R-profiling --with-tcltk
      - name: Compile R
        run: |
          export PATH=/home/runner/work/R-pkg/intel/bin/:$PATH
          export INTEL_LICENSE_FILE=/home/runner/work/R-pkg/intel
          source /opt/intel/mkl/bin/mklvars.sh intel64
          export _intel_arch=intel64
          export _intel_lib=mkl_intel_lp64
          export MKL="-L${MKLROOT}/lib/intel64 -lmkl_intel_lp64 -lmkl_intel_thread -lmkl_core -lmkl_rt -lpthread -lm -ldl"
          export _intel_cc_opt="-O3 -fPIC -m64 -march=native -fp-model precise -fp-model source -I${MKLROOT}/include"
          export LDFLAGS="-qopenmp"
          export CFLAGS="${_intel_cc_opt}"
          export CXXFLAGS="${_intel_cc_opt}"
          export FFLAGS="${_intel_cc_opt}"
          export FCFLAGS="${_intel_cc_opt}"
          export CC="icc"
          export CXX="icpc"
          export F77="ifort"
          export FC="ifort"
          export AR="xiar"
          export LD="xild"
          export LD_LIBRARY_PATH=/home/runner/work/R-pkg/intel/compilers_and_libraries_2020.3.275/linux/compiler/lib/intel64_lin/
          source /home/runner/work/R-pkg/intel/bin/compilervars.sh ${_intel_arch}
          cd /home/runner/work/R-pkg/R-4.0.2/
          make
          cd .. && tar -I zstd -cf R-4.0.2.tar.zst R-4.0.2/
          mv R-4.0.2.tar.zst ./R-pkg/
      - name: Install & Benchmark
        run: |
          export PATH=/home/runner/work/R-pkg/intel/bin/:$PATH
          export INTEL_LICENSE_FILE=/home/runner/work/R-pkg/intel
          source /opt/intel/mkl/bin/mklvars.sh intel64
          export _intel_arch=intel64
          export _intel_lib=mkl_intel_lp64
          export MKL="-L${MKLROOT}/lib/intel64 -lmkl_intel_lp64 -lmkl_intel_thread -lmkl_core -lmkl_rt -lpthread -lm -ldl"
          export _intel_cc_opt="-O3 -fPIC -m64 -march=native -fp-model precise -fp-model source -I${MKLROOT}/include"
          export LDFLAGS="-qopenmp"
          export CFLAGS="${_intel_cc_opt}"
          export CXXFLAGS="${_intel_cc_opt}"
          export FFLAGS="${_intel_cc_opt}"
          export FCFLAGS="${_intel_cc_opt}"
          export CC="icc"
          export CXX="icpc"
          export F77="ifort"
          export FC="ifort"
          export AR="xiar"
          export LD="xild"
          export LD_LIBRARY_PATH=/home/runner/work/R-pkg/intel/compilers_and_libraries_2020.3.275/linux/compiler/lib/intel64_lin/
          source /home/runner/work/R-pkg/intel/bin/compilervars.sh ${_intel_arch}
          cd /home/runner/work/R-pkg/R-4.0.2/
          mkdir /home/runner/work/R-pkg/R/
          mkdir /home/runner/work/R-pkg/R/library/
          cd /home/runner/work/R-pkg/R-4.0.2/
          sudo -E env "LD_LIBRARY_PATH=$LD_LIBRARY_PATH" env "PATH=$PATH" make install
          cd /home/runner/work/R-pkg/R-pkg/
          #Rscript pkg.R
          #cd /home/runner/work/R-pkg/ && tar -I zstd -cf pkg.tar.zst R/
          #mv pkg.tar.zst /home/runner/work/R-pkg/R-pkg/
          ls -al /home/runner/work/R-pkg/
          cd /home/runner/work/R-pkg/R-pkg/
          export RELEASE_TAG=$(git tag -l)
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Packages built for Ubuntu Bionic
          draft: false
          prerelease: false
      - name: Upload Release Asset
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} 
          asset_path: /home/runner/work/R-pkg/R-pkg/R-4.0.2.tar.zst
          asset_name: R-4.0.2.tar.zst
          asset_content_type: application/x-tar
